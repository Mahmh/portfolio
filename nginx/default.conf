server {
    listen 80;
    server_name mahermah.com www.mahermah.com workbox.mahermah.com blog.mahermah.com analytics.mahermah.com;

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 80 default_server;
    server_name _;
    return 444;
}

server {
    listen 443 ssl;
    http2 on;
    server_name mahermah.com www.mahermah.com;

    ssl_certificate     /etc/letsencrypt/live/mahermah.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mahermah.com/privkey.pem;

    location = /blog {
        return 301 https://blog.mahermah.com/;
    }
    location ^~ /blog/ {
        rewrite ^/blog/(.*)$ https://blog.mahermah.com/$1 permanent;
    }

    location / {
        proxy_pass http://client:5173;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_cache_bypass $http_upgrade;
    }

    location /api/ {
        proxy_pass http://server:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name blog.mahermah.com;

    ssl_certificate     /etc/letsencrypt/live/mahermah.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mahermah.com/privkey.pem;

    location = /blog {
        return 301 https://blog.mahermah.com/;
    }
    location ^~ /blog/ {
        rewrite ^/blog/(.*)$ https://blog.mahermah.com/$1 permanent;
    }

    # assets/HMR as-is
    location ~* ^/(@vite|src|assets|node_modules|favicon\.ico|robots\.txt|manifest(?:\.webmanifest)?|vite\.svg|.*\.(?:js|mjs|ts|tsx|css|map|png|jpe?g|gif|svg|ico|webp|avif|woff2?|ttf|otf|eot|json|txt))$ {
        proxy_pass http://client:5173;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_cache_bypass $http_upgrade;
    }

    location /api/ {
        proxy_pass http://server:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        proxy_pass http://client:5173/blog/;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_cache_bypass $http_upgrade;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name analytics.mahermah.com;

    ssl_certificate     /etc/letsencrypt/live/mahermah.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mahermah.com/privkey.pem;

    location / {
        proxy_pass http://umami:3000;
        proxy_http_version 1.1;
        proxy_set_header Host            $host;
        proxy_set_header Upgrade         $http_upgrade;
        proxy_set_header Connection      "upgrade";
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass               $http_upgrade;
    }
}

server {
    listen 443 ssl default_server;
    http2 on;
    server_name _;
    ssl_certificate     /etc/letsencrypt/live/mahermah.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mahermah.com/privkey.pem;
    return 444;
}